
services:
  # ========================================
  # MongoDB - Base de données
  # ========================================
  mongo:
    image: mongo:7
    container_name: socium_mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - mongo_data:/data/db
    networks:
      - socium_net
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 5s
      timeout: 5s
      retries: 10

  # ========================================
  # Data Generator - Génération auto des données
  # ========================================
  data-generator:
    image: python:3.11-slim
    container_name: socium_data_generator
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - ./mongo:/app
    working_dir: /app
    networks:
      - socium_net
    env_file:
      - .env
    command: bash -c "pip install -r requirements.txt && python socium_generator_v5.py"
    restart: "no"

  # ========================================
  # Metrics Agent - Pipeline Datadog (manuel)
  # ========================================
  metrics-agent:
    build: ./metrics-agent
    container_name: socium_metrics_agent
    restart: unless-stopped
    depends_on:
      - mongo
      - data-generator
    env_file:
      - .env
    networks:
      - socium_net
    command: tail -f /dev/null

volumes:
  mongo_data:

networks:
  socium_net:
